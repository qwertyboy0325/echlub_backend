# Collaboration Module 測試計劃

本文件說明 Collaboration Module 的測試策略、測試類型以及如何執行測試。

## 目錄

1. [測試架構](#測試架構)
2. [單元測試](#單元測試)
3. [整合測試](#整合測試)
4. [端對端測試](#端對端測試)
5. [負載測試](#負載測試)
6. [測試覆蓋率](#測試覆蓋率)
7. [疑難排解](#疑難排解)
8. [測試結果](#測試結果)

## 測試架構

我們採用以下層次的測試：

- **單元測試**：測試單一類別/元件的功能
- **整合測試**：測試元件之間的互動
- **端對端測試**：測試完整的使用者流程
- **負載測試**：測試系統在高負載情況下的穩定性和效能

測試工具：
- Jest：執行單元測試和整合測試
- Socket.io-client：測試 WebSocket 功能
- ts-node：執行 TypeScript 測試腳本

## 單元測試

單元測試專注於驗證個別元件的行為是否符合預期。

### 測試範圍

- 領域物件 (Room, PeerConnection)
- 值物件 (RoomRuleVO, ConnectionStateVO)
- 服務類 (MessageQueueService, MonitoringService)

### 執行方式

```bash
# 執行所有單元測試
npm test -- --testPathPattern=unit

# 執行特定元件的測試
npm test -- --testPathPattern=unit/room.aggregate.test.ts
```

### 關鍵測試案例

1. **Room 聚合根**
   - 測試創建房間、加入/離開房間、更新規則
   - 測試領域事件發佈
   - 測試驗證規則 (如最大人數)

2. **MessageQueueService**
   - 測試訊息佇列功能
   - 測試訊息優先級
   - 測試批次處理

## 整合測試

整合測試驗證元件之間的協同工作能力。

### 測試範圍

- 控制器與儲存庫的整合
- 使用案例與領域物件的整合
- 事件發佈與處理

### 執行方式

```bash
# 執行所有整合測試
npm test -- --testPathPattern=integration

# 執行特定整合測試
npm test -- --testPathPattern=integration/room.controller.test.ts
```

### 關鍵測試案例

1. **RoomController**
   - 測試房間創建與儲存庫互動
   - 測試房間狀態查詢
   - 測試錯誤處理

2. **SignalService**
   - 測試與訊息佇列的整合
   - 測試 WebRTC 信令處理流程

## 端對端測試

端對端測試模擬真實使用者情境，驗證系統各部分能協同運作。

### 前提條件

- 伺服器已啟動並監聽連接
- WebSocket 伺服器已設定並運行

### 執行方式

```bash
# 先啟動伺服器
npm run start:dev

# 在另一個終端視窗執行端對端測試
npm test -- --testPathPattern=e2e/websocket.test.ts
```

### 關鍵測試案例

1. **WebSocket 連接**
   - 測試客戶端連接到伺服器
   - 測試加入/離開房間
   - 測試斷開連接處理

2. **信令交換**
   - 測試 Offer/Answer 交換
   - 測試 ICE 候選交換
   - 測試完整的信令流程

## 負載測試

負載測試評估系統在高負載情況下的穩定性和效能。

### 前提條件

- 伺服器已啟動並監聽連接
- 資料庫連接已設定
- 系統監控已設定 (可選)

### 執行方式

```bash
# 先啟動伺服器
npm run start:dev

# 執行負載測試
npx ts-node src/tests/collaboration/e2e/load-test.ts
```

### 關鍵測試案例

1. **四玩家房間測試**
   - 模擬 4 個玩家同時連接
   - 測試全網狀的 WebRTC 連接 (6 條連接)
   - 測試大量 ICE 候選交換

2. **效能測試**
   - 監控訊息處理速率
   - 監控連接建立時間
   - 測試系統資源使用情況

### 預期結果

- 系統能同時處理 4 個對等連接的信令交換
- 訊息處理速率應保持穩定
- 錯誤數量應保持在最低 (0-1 個)
- CPU 和記憶體使用率應在可接受範圍內

## 測試覆蓋率

我們的目標是達到以下測試覆蓋率：

- 單元測試：>80% 程式碼覆蓋率
- 整合測試：>70% 元件整合覆蓋率
- 端對端測試：覆蓋所有關鍵使用者流程

### 檢查測試覆蓋率

```bash
npm test -- --coverage
```

## 疑難排解

### 常見問題

1. **連接被拒絕**
   - 檢查伺服器是否正在運行
   - 檢查埠號是否正確
   - 檢查防火牆設定

2. **測試逾時**
   - 增加測試逾時時間
   - 檢查異步操作是否正確完成
   - 檢查網路連接

3. **Socket.IO 連接問題**
   - 檢查路徑是否正確 ('/collaboration')
   - 確認 CORS 設定允許本機測試
   - 嘗試使用不同的傳輸協議 (websocket, polling)

### 除錯技巧

1. 啟用詳細日誌
   ```typescript
   // 設定環境變數
   process.env.DEBUG = 'socket.io:*';
   ```

2. 監控 WebSocket 流量
   - 使用瀏覽器開發者工具
   - 使用 Wireshark 捕獲網路封包

3. 檢查資源使用情況
   ```bash
   # 在 Linux/macOS 上
   top -p $(pgrep -f node)
   
   # 在 Windows 上使用工作管理員
   ``` 

## 測試結果

### 最近測試執行結果 (2025/5/7)

#### 通過的測試
1. **單元測試**:
   - `room.aggregate.test.ts`: 所有測試通過，確認了聚合根的核心功能
   - `message-queue.service.test.ts`: 所有測試通過，確認了訊息佇列處理邏輯

2. **整合測試**:
   - `room.controller.test.ts`: 所有測試通過，確認了控制器與儲存庫的互動

#### 失敗的測試
1. **端對端測試**:
   - `websocket.test.ts`: 部分測試失敗，主要是在「玩家加入房間觸發事件」的測試中出現錯誤，錯誤訊息為 "room.join is not a function"

#### 覆蓋率評估
當前測試覆蓋率情況：
- 領域實體與值物件測試覆蓋率良好
- 基礎設施層服務的測試覆蓋率良好
- 控制器與介面層測試覆蓋率良好

#### 後續改進建議
1. **修復 WebSocket 測試**:
   - 檢查 mock 物件的實現，確保它們正確模擬相應的方法
   - 在測試中加入更多的錯誤處理和調試輸出

2. **擴展測試覆蓋範圍**:
   - 為所有領域事件添加單獨的單元測試
   - 增加錯誤處理和極端情況的測試

3. **優化測試執行**:
   - 減少測試間的相互依賴性
   - 加快測試執行速度，特別是 WebSocket 測試

4. **CI/CD 整合**:
   - 將測試整合到持續整合流程中
   - 設置測試覆蓋率閾值，確保高品質的代碼提交 